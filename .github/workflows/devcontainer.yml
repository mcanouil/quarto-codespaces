name: "Build: Docker Images"

on:
  workflow_dispatch:
  release:
    types: [published]
  schedule:
    - cron: "0 6 * * sun"
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build - Quarto ${{ matrix.QUARTO_VERSION }} (${{ matrix.IMAGE }})
    if: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' }}
    strategy:
      matrix:
        include:
          - QUARTO_VERSION: release
            IMAGE_TAG: release,release-jammy,latest
            IMAGE: buildpack-deps:jammy-curl
            USER: vscode
          - QUARTO_VERSION: prerelease
            IMAGE_TAG: prerelease,prerelease-jammy
            IMAGE: buildpack-deps:jammy-curl
            USER: vscode
          # - QUARTO_VERSION: release
          #   IMAGE_TAG: release-universal
          #   IMAGE: mcr.microsoft.com/devcontainers/universal:latest
          #   USER: codespace
          # - QUARTO_VERSION: prerelease
          #   IMAGE_TAG: prerelease-universal
          #   IMAGE: mcr.microsoft.com/devcontainers/universal:latest
          #   USER: codespace
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3
      - name: Setup Docker buildx for multi-architecture builds
        uses: docker/setup-buildx-action@v3
        with:
          use: true
      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Push Docker image Setting
        id: push
        env:
          PUSH_DOCKER_IMAGE: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' }}
        run: |
          if [ "${PUSH_DOCKER_IMAGE}" = "true" ]; then
            echo "PUSH=always" >$GITHUB_OUTPUT
          else
            echo "PUSH=never" >$GITHUB_OUTPUT
          fi
      - name: Define Image Version
        id: image_version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi
      - name: Build and run Dev Container on release
        uses: devcontainers/ci@v0.3
        with:
          subFolder: .github
          imageName: ghcr.io/${{ github.repository }}
          cacheFrom: ghcr.io/${{ github.repository }}
          noCache: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' }}
          imageTag: ${{ matrix.IMAGE_TAG }}
          push: ${{ steps.push.outputs.PUSH }}
          platform: linux/amd64
        env:
          IMAGE: ${{ matrix.IMAGE }}
          QUARTO_VERSION: ${{ matrix.QUARTO_VERSION }}
          USER: ${{ matrix.USER }}
          ANNOTATION_VERSION: "${{ steps.image_version.outputs.VERSION }} (${{ github.sha }})"
          ANNOTATION_TITLE: "Quarto Codespaces"
          ANNOTATION_DESCRIPTION: "Quarto Codespaces / Dev Containers setup for quick online testing and workshops."
          ANNOTATION_AUTHORS: "MickaÃ«l CANOUIL <https://mickael.canouil.fr>"
          ANNOTATION_URL: ${{ github.server_url }}/${{ github.repository }}
          ANNOTATION_LICENSE: "MIT"
      - name: Test Dev Container
        if: ${{ github.event_name == 'release' }}
        env:
          QUARTO_VERSION: ${{ matrix.QUARTO_VERSION }}
        run: |
          echo "::group::Quarto Check"
          docker container run \
            --rm \
            --platform linux/amd64 \
            --quiet \
            --user vscode \
            --volume "/tmp:/workspaces/quarto-codespaces" \
            --workdir /workspaces/quarto-codespaces \
            ghcr.io/${GITHUB_REPOSITORY}:${QUARTO_VERSION} /bin/bash -c "quarto check --output quarto-check.json"

          quarto_check=$(cat /tmp/quarto-check.json)
          echo "${quarto_check}"
          echo "::endgroup::"
          echo "## Quarto Check Results: ${{ matrix.QUARTO_VERSION }}" >>$GITHUB_STEP_SUMMARY
          echo "<details><summary>Quarto Check Results</summary>" >>$GITHUB_STEP_SUMMARY
          echo "" >>$GITHUB_STEP_SUMMARY
          echo '```json' >>$GITHUB_STEP_SUMMARY
          echo "${quarto_check}" >>$GITHUB_STEP_SUMMARY
          echo '```' >>$GITHUB_STEP_SUMMARY
          echo "" >>$GITHUB_STEP_SUMMARY
          echo "</details>" >>$GITHUB_STEP_SUMMARY

  build-versions:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    needs:
      - "build"
    name: Build - Quarto ${{ matrix.QUARTO_VERSION }}
    strategy:
      matrix:
        PLATFORM:
          - "linux/amd64"
        QUARTO_VERSION:
          - "1.0"
          - "1.1"
          - "1.2"
          - "1.3"
          - "1.4"
          - "1.5"
          - "1.6"
          - "1.7"
        include:
          - QUARTO_VERSION: "1.0"
            PLATFORM: "linux/amd64"
          - QUARTO_VERSION: "1.1"
            PLATFORM: "linux/amd64"
          - QUARTO_VERSION: "1.2"
            PLATFORM: "linux/amd64"
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@v3
      - name: Setup Docker buildx for multi-architecture builds
        uses: docker/setup-buildx-action@v3
        with:
          use: true
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and run Dev Container on release
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/${{ github.repository }}
          cacheFrom: ghcr.io/${{ github.repository }}
          noCache: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' }}
          imageTag: ${{ matrix.QUARTO_VERSION }},${{ matrix.QUARTO_VERSION }}-jammy
          push: always
          platform: ${{ matrix.PLATFORM }}
          configFile: ${{ format('.devcontainer/mcanouil-{0}/devcontainer.json', matrix.QUARTO_VERSION) }}

  clean:
    runs-on: ubuntu-latest
    needs:
      - "build-versions"
    if: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' }}
    continue-on-error: true
    steps:
      - name: Delete obsolete/untagged versions
        uses: actions/delete-package-versions@v5
        with:
          package-name: ${{ github.event.repository.name }}
          package-type: "container"
          token: ${{ secrets.GITHUB_TOKEN }}
          delete-only-untagged-versions: "true"
